#! /bin/sh
#
# chkconfig: 2345 90 10
# description: This script starts or stops the colmet aggregator
# processname: colmet
# pidfile: /var/run/colmet.pid


### BEGIN INIT INFO
# Provides:          colmet
# Required-Start:    $network $local_fs
# Required-Stop:     $network $local_fs
# Default-Start:     S 2 3 4 5
# Default-Stop:      0 1 6
# X-Start-Before: oar-node
# X-Stop-After: oar-node
# Short-Description: Colmet Aggregator
# Description:       This script starts or stops the colmet aggregator
### END INIT INFO

# Author: Philippe Le Brouster <philippe.le-brouster@imag.fr>
#

LANG=C
export LANG

PATH=/usr/local/bin:/sbin:/usr/sbin:/bin:/usr/bin:$PATH

DEFAULTCONF=/etc/default/colmet

DAEMON_START="1"
NAME=colmet
DESC="Colmet Aggregator"
PIDFILE=/var/run/$NAME.pid
LOGFILE=/var/log/colmet/aggregator.log
DAEMON=$(which colmet)
DAEMON_NAME=colmet
DAEMON_OPTS="-vv -d 10 -i zeromq_aggregator --zeromq-bind-uri tcp://0.0.0.0:5556 -o zeromq --zeromq-uri ipc:///tmp/colmet_collector"

# Read configuration variable file if it is present
[ -r "$DEFAULTCONF" ] && . "$DEFAULTCONF"

DAEMON_ARGS="--daemon --pidfile $PIDFILE --logfile $LOGFILE"

NOLSB=

[ -f /lib/lsb/init-functions ] || NOLSB=yes

if [ -f /etc/debian_version ]; then
    system=debian
elif [ -f /etc/redhat-release ]; then
    system=redhat
elif [ -f /etc/SuSE-release ]; then
    system=suse
elif [ -f /etc/gentoo-release ]; then
    system=gentoo
fi

if [ -z "$NOLSB" ]; then
    . /lib/lsb/init-functions
    fail_msg() {
        echo ""
        log_failure_msg "$@"
    }
    warn_msg() {
        log_warning_msg "$@"
    }
    succ_msg() {
        log_success_msg "$@"
    }
    begin_msg() {
        echo -n "$@:"
    }
else
    echo "This system doesn't provide the LSB functions. Failing"
    exit 2
fi


# Exit if the package is not installed
[ -x "$DAEMON" ] || exit 0

do_start(){
	begin_msg "Starting the colmet aggregator"
	if [ "$DAEMON_START" != "1" ]; then
		warn_msg "Autostart disabled."
		return 0
	fi

	if pidofproc -p $PIDFILE > /dev/null; then
		fail_msg "already running"
		exit 2
	fi

        [ ! -d "$(dirname $LOGFILE)" ] && mkdir -p "$(dirname $LOGFILE)"

	start_daemon -p "$PIDFILE" "$DAEMON" $DAEMON_ARGS $DAEMON_OPTS
        if [ "$?" != 0 ]; then
            fail_msg "Unable to start"
        else
            succ_msg
            # redhat world
            [ -d /var/lock/subsys/ ] && touch  /var/lock/subsys/$NAME
        fi
	return 0
}

do_stop() {
    begin_msg "Stopping $DESC"
    # Return
    #   0 if daemon has been stopped
    #   1 if daemon was already stopped
    #   2 if daemon could not be stopped
    #   other if a failure occurred
    killproc -p "$PIDFILE"
    RETVAL="$?"
    if [ "$RETVAL" = 2 ]; then
        fail_msg "Unable to stop $DESC"
        exit 2
    fi
    # Many daemons don't delete their pidfiles when they exit.
    rm -f $PIDFILE

    # redhat world
    [ -d /var/lock/subsys/ ] && rm -f /var/lock/subsys/$NAME

    succ_msg
    return 0
}

case "$1" in
    start)
        do_start
        ;;
    stop)
        do_stop
        ;;
    reload|restart|force-reload)
        if do_stop; then
            sleep 1
            do_start
        fi
        ;;
    *)
        echo "Usage: $SCRIPTNAME {start|stop|restart|force-reload}" >&2
        exit 1
        ;;
esac

:

